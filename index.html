<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="./stocklib.js"></script>
  <style>
    .stock-table {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
      border-right: 1px solid #666;
      border-left: 1px solid #666;
    }

    .stock-table-header {
      display: flex;
      border-bottom: 1px solid #666;
      border-top: 1px solid #666;
    }

    .stock-table-header-cell {
      display: flex;
      padding: 4px;
      border-collapse: collapse;
    }

    .stock-table-header-cell:not(:last-child) {
      border-right: 1px solid #666;
    }

    .stock-table-row {
      display: flex;
    }

    .stock-table-row:nth-child(even) {
      background: #eee;
    }

    .stock-table-row-cell {
      display: flex;
      border: 1px solid #eee8;
      padding: 4px;
      white-space: normal;
      word-break: break-all;
    }

    .stock-table-footer {
      display: flex;
      border-bottom: 1px solid #666;
      border-top: 1px solid #666;
    }

    .stock-table-footer-cell {
      display: flex;
      padding: 4px;
      border-collapse: collapse;
    }

    .stock-table-footer-cell-PL,
    .stock-table-footer-cell-PLPERCENT_SHOW,
    .stock-table-footer-cell-BPRICE {
      border-left: 1px solid #666;
    }

    .stock-table-row-cell-ICO {
      justify-content: center;
    }

    .stock-table-row-cell-ICO img {
      width: 20px;
    }
  </style>
</head>
<body>

<div id="tabHolder"></div>
<div id="tabHolder1"></div>
<div id="tabHolder2"></div>

<script>

  function RowsBuffer(columnsDefinition) {
    const rows = new Map();
    const ids = columnsDefinition.filter(col => col.key).map(col => col.id);
    const getKey = eval(`r => [r.${ids.join(', r.')}].join('-')`);

    return {
      getKey,
      get: (key) => {
        return rows.get(key);
      },
      update: (key, rowsArray) => {
        rows.set(key, rowsArray);
      },
      asArray: () => {
        const res = [];
        for (const rowsArray of Array.from(rows.values())) {
          res.push.apply(res, rowsArray);
        }
        return res;
      }
    }
  }

  function rowsCollapser(rows) {
    const map = new Map();
    const secIds = new Set();
    for (const row of rows) {
      const { SECID, TYPE } = row;
      const id = `${SECID}-${TYPE}`;
      if (map.has(id)) {
        const prevRow = map.get(id);
        const newRow = {
          ...prevRow,
          LOW: row.LOW,
          HIGH: row.HIGH,
          MARKETPRICE: row.MARKETPRICE,
          VOLTODAY: row.VOLTODAY,
          LCURRENTPRICE: row.LCURRENTPRICE,
          YIELD: row.YIELD,
          DEALPRICE_SHOW: row.DEALPRICE_SHOW,
          QUANTITY: new Decimal(row.QUANTITY).plus(prevRow.QUANTITY).toNumber(),
          PL: new Decimal(row.PL).plus(prevRow.PL).toNumber(),
          BPRICE: new Decimal(row.BPRICE).plus(prevRow.BPRICE).toNumber(),
        };
        map.set(id, newRow);
      } else {
        map.set(id, row);
        secIds.add(SECID);
      }
    }

    // collapse zero sum
    for (const SECID of secIds) {
      const sellId = `${SECID}-sell`;
      const buyId = `${SECID}-buy`;
      const sell = map.get(sellId);
      const buy = map.get(buyId);

      if (buy && sell && buy.QUANTITY - sell.QUANTITY === 0) {
        map.delete(sellId);
        map.delete(buyId);
      }
    }
    return Array.from(map.values());
  }

  function TableSubscription(stockClient, tabHolder, columns, portfolioId) {
    // String sort function
    const sortFunc = (rows) => {
      return rows.sort((a, b) => {
        return a.SECID > b.SECID ? 1 : a.SECID < b.SECID ? -1 : 0;
      });
    };

    const stockTable = new StockLib.Table(tabHolder, columns);
    /*stockTable.onHeaderCellClick((e) => {
      console.log('[[onHeaderCellClick]]', e);
    });

    stockTable.onCellClick((e) => {
      console.log('[[onCellClick]]', e);
    });*/

    stockClient.listPortfolios(portfolioId).then(securities => {
      const rowsBuffer = new RowsBuffer(columns);
      const subscription = {};
      for (const sec of securities) {
        const {
          board: boardid, secid, create_at, type, low, high, last, value, closeprice, marketprice, voltoday,
          lcurrentprice, issuecapitalization, yieldtoprevyield, yieldtooffer, yieldlastcoupon, quantity, buyprice, pnl
        } = sec;
        if (!subscription[boardid]) {
          subscription[boardid] = [];
        }
        const lCurPriceDecimal = new Decimal(lcurrentprice || 0);
        const isBuy = type.toLowerCase() === 'buy';
        const bpriceDecimal = lCurPriceDecimal.mul(quantity || 0);
        const pnlDecimal = new Decimal(pnl);
        const plpercent = pnlDecimal.mul(100).div(bpriceDecimal);
        const row = {
          SECID: secid,
          BOARDID: boardid,
          LOW: low,
          HIGH: high,
          MARKETPRICE: marketprice,
          VOLTODAY: voltoday,
          DEALPRICE_SHOW: lcurrentprice > 0 ? lcurrentprice : `-${lcurrentprice}`,
          TYPE_SHOW: isBuy ? 'Покупка' : 'Продажа',
          QUANTITY: quantity,
          YIELD: sec['yield'],
          BPRICE: `${isBuy ? bpriceDecimal.toString() : '0'}`,
          DEALPRICE: lCurPriceDecimal.toNumber(),
          BUYPRICE: buyprice,
          TYPE: type,
          PL: pnl,
          PLPERCENT_SHOW: `${plpercent.toString()}`,
          PLPERCENT: plpercent.toFixed(2),
          LCURRENTPRICE: '',
        };

        const id = rowsBuffer.getKey(row);
        const rowsArray = rowsBuffer.get(id) || [];
        rowsArray.push(row);
        rowsBuffer.update(id, rowsArray);
        subscription[boardid].push(secid);
      }

      const invocationId = stockClient.subscribeMarkets(subscription, buf => {

        for (const row of buf) {
          const id = rowsBuffer.getKey(row);
          // SECID,BOARDID,BID,BIDDEPTH,OFFER,OFFERDEPTH,SPREAD,BIDDEPTHT,OFFERDEPTHT,OPEN,LOW,HIGH,LAST,LASTCHANGE,LASTCHANGEPRCNT,QTY,VALUE,VALUE_USD,WAPRICE,LASTCNGTOLASTWAPRICE,WAPTOPREVWAPRICEPRCNT,WAPTOPREVWAPRICE,CLOSEPRICE,MARKETPRICETODAY,MARKETPRICE,LASTTOPREVPRICE,NUMTRADES,VOLTODAY,VALTODAY,VALTODAY_USD,ETFSETTLEPRICE,TRADINGSTATUS,UPDATETIME,ADMITTEDQUOTE,LASTBID,LASTOFFER,LCLOSEPRICE,
          // LCURRENTPRICE,MARKETPRICE2,NUMBIDS,NUMOFFERS,CHANGE,TIME,HIGHBID,LOWOFFER,PRICEMINUSPREVWAPRICE,OPENPERIODPRICE,SEQNUM,SYSTIME,CLOSINGAUCTIONPRICE,CLOSINGAUCTIONVOLUME,ISSUECAPITALIZATION,ISSUECAPITALIZATION_UPDATETIME,ETFSETTLECURRENCY,VALTODAY_RUR,SHORTNAME,PREVPRICE,LOTSIZE,FACEVALUE,STATUS,BOARDNAME,DECIMALS,SECNAME,REMARKS,MARKETCODE,INSTRID,SECTORID,MINSTEP,PREVWAPRICE,FACEUNIT,PREVDATE,ISSUESIZE,ISIN,LATNAME,REGNUMBER,PREVLEGALCLOSEPRICE,PREVADMITTEDQUOTE,CURRENCYID,SECTYPE,LISTLEVEL,SETTLEDATE
          const { YIELD, LCURRENTPRICE } = row;
          const rowsArray = rowsBuffer.get(id);

          const updateRows = rowsArray.map(bufRow => {
            bufRow.LCURRENTPRICE = LCURRENTPRICE;
            // bufRow.DEALPRICE - цена покупки
            if (bufRow.TYPE === 'buy') {
              const lcurrentprice = new Decimal(LCURRENTPRICE || 0);
              const pl = lcurrentprice.minus(bufRow.DEALPRICE).mul(bufRow.QUANTITY);
              const plpercent = pl.mul(100).div(bufRow.BPRICE);
              bufRow.BRPICE = lcurrentprice.mul(bufRow.QUANTITY).toNumber();
              bufRow.PL = pl.toString();
              bufRow.PLPERCENT_SHOW = `${plpercent.toFixed(2)} %`;
              bufRow.PLPERCENT = plpercent.toFixed(2);
              // PL * 100 / BPRICE
            }
            bufRow.YIELD = YIELD;

            return bufRow;
          });

          rowsBuffer.update(id, updateRows);
        }

        const sortedRowsArray = sortFunc(rowsBuffer.asArray());
        const totals = {
          PL: new Decimal(0),
          BPRICE: new Decimal(0),
          PLPERCENT: new Decimal(0),
        };
        sortedRowsArray.map(row => {
          totals.PL = totals.PL.add(row.PL);
          totals.BPRICE = totals.BPRICE.add(row.BPRICE);
          totals.PLPERCENT = totals.PLPERCENT.add(row.PLPERCENT);
        });

        stockTable.render(
          rowsCollapser(sortedRowsArray),
          {
            PL: totals.PL.toString(),
            BPRICE: totals.BPRICE.toString(),
            PLPERCENT_SHOW: totals.PLPERCENT.toString(),
          }
        );
      });
    }).catch(e => console.error(e));

    return {
      // incocationId,
      /*unsubscribe: () => {
        stockClient.unsubscribe(invocationId);
      }*/
    }
  }


  StockLib.run('development').then(() => {
    const stockClient = new StockLib.Client('https://api.brox.club:1313');

    stockClient.connect().then(() => {

      /*stockClient.listFields().then((response) => {
        console.log(response);
      }).catch(e => console.error(e));*/

      /*stockClient.listPortfolios(1).then(response => {
        console.log(response);
      }).catch(e => console.error(e));*/

      /*stockClient.listSecurities({
        // fields: ['BOARDID', 'SECID', 'ISIN', 'SECNAME'],
        filter: 'SU26232RMFS7'
      }).then(response => {
        console.log(response);
      }).catch(e => console.error(e));*/

      const columns = [
        // {
        //  id: 'SECID', // ID for each column
        //  key?: true, // key - does column type is key (must be at least one key! for to collect rows to map)
        //  caption?: 'Column caption', // Column header text
        //  className?: 'column-css-class', // Column class name
        //  style?: { width: '100px' }, // Header/row cell runtime styles
        //  hidden?: false, // does column hidden? may be hidden column with key definition
        //  renderCell?: () => {}, // cell render callback (using if defined)
        //  renderHeaderCell?: () => {} // header cell render callback (using if defined)
        // }
        {id: 'ICO', style: { width: '40px' },
          renderCell: (col, row, rowIndex, className) => {
            return React.createElement('div', {
                className,
                style: col.style,
                key: `img-${rowIndex}`,
              },
              React.createElement('img', {
                src: `https://api.brox.club/ICO/${row.SECID}.ico`,
              })
            );
          }
        },
        {id: 'SECID', key: true, caption: 'Тикер', className: 'security', style: {width: '170px'}},
        // {id: 'shortname', caption: 'Short name', className: 'shortname', style: {width: '100px'}},
        // {id: 'secname', caption: 'Security name', className: 'secname', style: {width: '200px'}},
        {id: 'LOW', caption: 'Мин. цена', style: {width: '100px'}},
        {id: 'HIGH', caption: 'Макс. цена', style: {width: '100px'}},
        {id: 'MARKETPRICE', caption: 'Рын. цена', style: {width: '100px'}},
        {id: 'VOLTODAY', caption: 'Объём', style: { width: '100px' }},
        {id: 'LCURRENTPRICE', caption: 'Текущая цена', style: {width: '100px'}},
        {id: 'YIELD', caption: 'Дивиденд', style: {width: '100px'}},
        {id: 'TYPE_SHOW', caption: 'Тип сделки', style: {width: '100px'}},
        {id: 'QUANTITY', caption: 'Кол-во бумаги', style: {width: '100px'}},
        {id: 'DEALPRICE_SHOW', caption: 'Цена сделки', style: {width: '100px'}},
        {id: 'PL', caption: 'Прибыль/убыток', style: {width: '100px'}},
        {id: 'PLPERCENT_SHOW', caption: '%', style: {width: '100px'}},
        {id: 'BPRICE', caption: 'Стоимость лота', style: { width: '100px'}},
        // {id: 'open', caption: 'Open', style: {width: '200px'}},
        // {id: 'value', caption: 'Value', style: {width: '200px'}},
        {id: 'BOARDID', key: true, hidden: true},
        {id: 'DEALPRICE', hidden: true},
        {id: 'TYPE', hidden: true},
        {id: 'PLPERCENT', hidden: true}
      ];

      const tabHolder = document.getElementById('tabHolder');
      const tabHolder1 = document.getElementById('tabHolder1');
      const tabHolder2 = document.getElementById('tabHolder2');
      const subscription1 = new TableSubscription(stockClient, tabHolder, columns, 1);
      const subscription2 = new TableSubscription(stockClient, tabHolder1, columns, 2);
      const subscription3 = new TableSubscription(stockClient, tabHolder2, columns, 3);

    });

  });

</script>
</body>
</html>
